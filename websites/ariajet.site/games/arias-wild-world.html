<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aria's Wild World - Wildlife Survival Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #87CEEB 0%, #98D8C8 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            background: #2d5016;
            border: 4px solid #1a3009;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 1000px;
            width: 100%;
        }

        .game-header {
            text-align: center;
            color: #fff;
            margin-bottom: 20px;
        }

        .game-header h1 {
            font-size: 2.5em;
            text-shadow: 3px 3px 0 #000;
            margin-bottom: 10px;
        }

        .game-header .subtitle {
            font-size: 1.1em;
            color: #ffd700;
        }

        .game-header .time-display {
            font-size: 1.2em;
            color: #98D8C8;
            margin-top: 10px;
        }

        .game-ui {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .game-ui.full-map {
            flex-direction: row;
        }

        .game-ui.full-map .game-sidebar {
            max-width: 320px;
        }

        .game-canvas-container {
            position: relative;
            background: #4a7c2a;
            border: 3px solid #1a3009;
            border-radius: 4px;
            overflow: hidden;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 600px;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
        }

        .game-ui.full-map #gameCanvas {
            height: 700px;
        }

        .game-sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }

        .game-ui.full-map .game-sidebar {
            width: 320px;
            flex-shrink: 0;
        }

        .map-toggle {
            background: #4a7c2a;
            border: 2px solid #1a3009;
            color: #fff;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .map-toggle:hover {
            background: #5a8c3a;
        }

        .info-panel {
            background: #1a3009;
            border: 2px solid #4a7c2a;
            border-radius: 4px;
            padding: 15px;
            color: #fff;
        }

        .info-panel h3 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.9em;
        }

        .stat-label {
            color: #98D8C8;
        }

        .stat-value {
            color: #fff;
            font-weight: bold;
        }

        .message-box {
            background: #1a3009;
            border: 2px solid #4a7c2a;
            border-radius: 4px;
            padding: 18px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            color: #fff;
            font-size: 1em;
            line-height: 1.7;
        }

        .message {
            margin: 5px 0;
            padding: 10px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            animation: fadeIn 0.3s;
            font-size: 1em;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            background: #4a7c2a;
            border: 2px solid #1a3009;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #5a8c3a;
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.primary {
            background: #ff6b6b;
            border-color: #cc5555;
        }

        .btn.primary:hover {
            background: #ff7b7b;
        }

        .character-select {
            background: #1a3009;
            border: 2px solid #4a7c2a;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            color: #fff;
        }

        .character-select h2 {
            color: #ffd700;
            margin-bottom: 20px;
        }

        .character-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .character-option {
            background: #2d5016;
            border: 3px solid #4a7c2a;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            max-width: 150px;
        }

        .character-option:hover {
            border-color: #ffd700;
            transform: scale(1.05);
        }

        .character-option.selected {
            border-color: #ff6b6b;
            background: #3d6026;
        }

        .character-option .emoji {
            font-size: 3em;
            display: block;
            margin-bottom: 10px;
        }

        .character-option .name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .character-option .desc {
            font-size: 0.8em;
            color: #98D8C8;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 18px;
            background: #1a3009;
            border: 2px solid #4a7c2a;
            border-radius: 9px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a7c2a, #5a8c3a);
            transition: width 0.3s;
        }

        .progress-fill.hunger {
            background: linear-gradient(90deg, #ff6b6b, #ff8b8b);
        }

        .progress-fill.energy {
            background: linear-gradient(90deg, #4ecdc4, #6ee5dc);
        }

        .night-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 50, 0.7);
            pointer-events: none;
            transition: opacity 1s;
        }
    </style>
</head>

<body>
    <div class="game-container">
        <div class="game-header">
            <h1 id="titleIcon">üêæ Aria's Wild World üêæ</h1>
            <div class="subtitle">Survive as Wildlife in a Pixel World</div>
            <div class="time-display" id="timeDisplay">üåÖ Day 1</div>
        </div>

        <div id="characterSelect" class="character-select">
            <h2>Choose Your Animal</h2>
            <div class="character-options">
                <div class="character-option" data-animal="lion">
                    <div class="emoji">ü¶Å</div>
                    <div class="name">Lion</div>
                    <div class="desc">Strong hunter, powerful roar</div>
                </div>
                <div class="character-option" data-animal="wolf">
                    <div class="emoji">üê∫</div>
                    <div class="name">Wolf</div>
                    <div class="desc">Fast runner, pack hunter</div>
                </div>
                <div class="character-option" data-animal="fox">
                    <div class="emoji">ü¶ä</div>
                    <div class="name">Fox</div>
                    <div class="desc">Clever explorer, quick thinker</div>
                </div>
            </div>
            <button class="btn primary" id="startBtn">Start Your Adventure!</button>
        </div>

        <div id="gameScreen" class="hidden">
            <button class="map-toggle" id="mapToggle">üìê Toggle Map View</button>
            <div class="game-ui" id="gameUI">
                <div class="game-canvas-container">
                    <canvas id="gameCanvas"></canvas>
                    <div class="night-overlay" id="nightOverlay" style="opacity: 0;"></div>
                </div>
                <div class="game-sidebar">
                    <div class="info-panel">
                        <h3>Your Day</h3>
                        <div class="stat">
                            <span class="stat-label">Animal:</span>
                            <span class="stat-value" id="animalName">-</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Day:</span>
                            <span class="stat-value" id="dayCount">1</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Hunger:</span>
                            <div class="progress-bar">
                                <div class="progress-fill hunger" id="hungerBar" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Energy:</span>
                            <div class="progress-bar">
                                <div class="progress-fill energy" id="energyBar" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Food Found:</span>
                            <span class="stat-value" id="foodCount">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Hunted:</span>
                            <span class="stat-value" id="huntedCount">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Allies:</span>
                            <span class="stat-value" id="alliesCount">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Your Den:</span>
                            <span class="stat-value" id="denStatus">None</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Total Dens:</span>
                            <span class="stat-value" id="densCount">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Food from Allies:</span>
                            <span class="stat-value" id="allyFoodCount">0</span>
                        </div>
                    </div>

                    <div class="info-panel">
                        <h3>Story & Tips</h3>
                        <div class="message-box" id="messageBox"></div>
                    </div>

                    <div class="controls">
                        <button class="btn" id="buildDenBtn">üè† Build Den</button>
                        <button class="btn" id="restBtn">üò¥ Rest</button>
                        <button class="btn" id="huntBtn">üéØ Hunt</button>
                        <button class="btn" id="tameBtn">ü§ù Tame</button>
                        <button class="btn" id="saveBtn">üíæ Save</button>
                        <button class="btn" id="defendBtn">üõ°Ô∏è Defend</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            animal: null,
            x: 400,
            y: 250,
            hunger: 100,
            energy: 100,
            fullMapMode: true, // Start in full map mode
            food: 0,
            hunted: 0,
            allyFood: 0, // Food brought by allies
            allies: [],
            day: 1,
            timeOfDay: 0, // 0-100, 0-50 = day, 50-100 = night
            den: null, // Player's main den
            denBuilt: false,
            dens: [], // All dens (player + allies)
            fullMapMode: true, // Start in full map mode
            messages: [],
            world: {
                width: 1000,
                height: 600
            },
            wildlife: [],
            humans: [],
            foodItems: [],
            hasShownHungerWarning: false,
            hasShownEnergyWarning: false,
            lastMessageTime: 0,
            seenMessages: new Set()
        };

        // Animal stats
        const animalStats = {
            lion: { speed: 2.5, strength: 10, hunting: 8 },
            wolf: { speed: 4, strength: 7, hunting: 9 },
            fox: { speed: 3.5, strength: 5, hunting: 6 }
        };

        // Canvas Setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 1000;
        canvas.height = 600;

        // Character Selection
        const characterOptions = document.querySelectorAll('.character-option');
        const startBtn = document.getElementById('startBtn');
        const characterSelect = document.getElementById('characterSelect');
        const gameScreen = document.getElementById('gameScreen');

        characterOptions.forEach(option => {
            option.addEventListener('click', () => {
                characterOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                gameState.animal = option.dataset.animal;
            });
        });

        startBtn.addEventListener('click', () => {
            if (!gameState.animal) {
                alert("Please choose an animal first!");
                return;
            }
            characterSelect.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            startGame();
        });

        // Initialize World
        function initializeWorld() {
            // Create food items
            for (let i = 0; i < 8; i++) {
                gameState.foodItems.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    type: 'fruit',
                    collected: false
                });
            }

            // Create wildlife (prey animals)
            for (let i = 0; i < 6; i++) {
                gameState.wildlife.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    type: Math.random() > 0.5 ? 'rabbit' : 'deer',
                    tamed: false,
                    health: 100,
                    speed: 1 + Math.random() * 2,
                    angle: Math.random() * Math.PI * 2
                });
            }

            // Create humans (threats)
            for (let i = 0; i < 2; i++) {
                gameState.humans.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    health: 50,
                    speed: 1.5,
                    angle: Math.random() * Math.PI * 2,
                    threatLevel: 5,
                    hasWarned: false
                });
            }
        }

        // Game Functions
        function startGame() {
            loadGame();
            if (gameState.wildlife.length === 0) {
                initializeWorld();
            }

            // All animals start with a den (their home)
            if (!gameState.denBuilt) {
                gameState.den = { x: gameState.x || canvas.width / 2, y: gameState.y || canvas.height / 2 };
                gameState.denBuilt = true;
                gameState.dens.push({ x: gameState.den.x, y: gameState.den.y, type: 'player' });
            }

            // Set up map toggle
            setupMapToggle();

            applyAnimalTheme();
            updateTitleIcon();
            updateUI();

            // Better Story & Tips messages
            addMessage(`üåç Welcome to Aria's Wild World! You're a ${gameState.animal.charAt(0).toUpperCase() + gameState.animal.slice(1)} starting Day ${gameState.day}.`);
            addMessage(`üè† You already have a den at your starting location - this is your safe home!`);
            addMessage(`üéÆ Move with WASD or Arrow Keys. Find food (berries üçì), hunt animals (rabbits üê∞, deer ü¶å), or tame them as allies!`);
            addMessage(`ü§ù Tamed allies will hunt for you and bring food back to dens you build for them.`);
            addMessage(`üè° Build more dens for your allies - they'll automatically move in and start hunting!`);
            addMessage(`üò¥ Rest at your den to recover energy and start a new day. Watch out for humans!`);

            gameLoop();
            timeLoop();
        }

        function setupMapToggle() {
            const toggle = document.getElementById('mapToggle');
            const gameUI = document.getElementById('gameUI');

            if (gameState.fullMapMode) {
                gameUI.classList.add('full-map');
                toggle.textContent = 'üìê Split View';
            } else {
                gameUI.classList.remove('full-map');
                toggle.textContent = 'üìê Full Map';
            }

            toggle.addEventListener('click', () => {
                gameState.fullMapMode = !gameState.fullMapMode;
                if (gameState.fullMapMode) {
                    gameUI.classList.add('full-map');
                    toggle.textContent = 'üìê Split View';
                } else {
                    gameUI.classList.remove('full-map');
                    toggle.textContent = 'üìê Full Map';
                }
            });
        }

        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        function timeLoop() {
            setInterval(() => {
                gameState.timeOfDay = (gameState.timeOfDay + 0.1) % 100;
                updateTimeDisplay();
            }, 100);
        }

        function updateTimeDisplay() {
            const timeDisplay = document.getElementById('timeDisplay');
            const isNight = gameState.timeOfDay > 50;
            const nightOverlay = document.getElementById('nightOverlay');

            if (isNight) {
                timeDisplay.textContent = `üåô Night - Day ${gameState.day}`;
                nightOverlay.style.opacity = 0.7;
            } else {
                timeDisplay.textContent = `üåÖ Day ${gameState.day}`;
                nightOverlay.style.opacity = 0;
            }
        }

        function update() {
            // Decrease hunger and energy over time
            if (gameState.hunger > 0) gameState.hunger -= 0.015;
            if (gameState.energy > 0) gameState.energy -= 0.008;

            // Update wildlife movement
            gameState.wildlife.forEach(animal => {
                if (!animal.tamed) {
                    animal.angle += (Math.random() - 0.5) * 0.2;
                    animal.x += Math.cos(animal.angle) * animal.speed;
                    animal.y += Math.sin(animal.angle) * animal.speed;

                    // Keep in bounds
                    animal.x = Math.max(20, Math.min(canvas.width - 20, animal.x));
                    animal.y = Math.max(20, Math.min(canvas.height - 20, animal.y));
                } else {
                    // Tamed animals have AI behavior
                    if (!animal.assignedDen) {
                        // Assign to nearest den or player's den
                        let targetDen = gameState.den;
                        if (gameState.dens.length > 0) {
                            let minDist = Infinity;
                            gameState.dens.forEach(den => {
                                const d = Math.sqrt(
                                    Math.pow(animal.x - den.x, 2) +
                                    Math.pow(animal.y - den.y, 2)
                                );
                                if (d < minDist) {
                                    minDist = d;
                                    targetDen = den;
                                }
                            });
                        }
                        animal.assignedDen = targetDen;
                        animal.hunting = false;
                        animal.huntCooldown = 0;
                    }

                    // Ally hunting behavior
                    if (!animal.hunting && animal.huntCooldown <= 0) {
                        // Look for nearby prey
                        let nearestPrey = null;
                        let minPreyDist = 80;

                        gameState.wildlife.forEach(prey => {
                            if (prey.health > 0 && !prey.tamed && prey.type !== animal.type) {
                                const dist = Math.sqrt(
                                    Math.pow(animal.x - prey.x, 2) +
                                    Math.pow(animal.y - prey.y, 2)
                                );
                                if (dist < minPreyDist) {
                                    minPreyDist = dist;
                                    nearestPrey = prey;
                                }
                            }
                        });

                        if (nearestPrey) {
                            // Start hunting
                            animal.hunting = true;
                            animal.huntTarget = nearestPrey;
                        } else {
                            // Follow player or return to den
                            const target = animal.assignedDen || { x: gameState.x, y: gameState.y };
                            const dx = target.x - animal.x;
                            const dy = target.y - animal.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist > 30) {
                                animal.x += (dx / dist) * animal.speed * 0.7;
                                animal.y += (dy / dist) * animal.speed * 0.7;
                            }
                        }
                    }

                    // If hunting, chase target
                    if (animal.hunting && animal.huntTarget) {
                        const dx = animal.huntTarget.x - animal.x;
                        const dy = animal.huntTarget.y - animal.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        if (dist < 25 && animal.huntTarget.health > 0) {
                            // Catch prey!
                            const success = Math.random() < 0.3; // 30% success rate for allies
                            if (success) {
                                animal.huntTarget.health = 0;
                                gameState.allyFood++;
                                gameState.hunger = Math.min(100, gameState.hunger + 10);
                                addMessage(`Your ${animal.type} caught food and brought it home!`);

                                // Respawn prey
                                setTimeout(() => {
                                    animal.huntTarget.x = Math.random() * canvas.width;
                                    animal.huntTarget.y = Math.random() * canvas.height;
                                    animal.huntTarget.health = 100;
                                }, 8000);
                            }

                            animal.hunting = false;
                            animal.huntTarget = null;
                            animal.huntCooldown = 300; // 5 seconds cooldown (at 60fps)
                        } else if (dist > 100 || animal.huntTarget.health <= 0) {
                            // Lost target or too far
                            animal.hunting = false;
                            animal.huntTarget = null;
                            animal.huntCooldown = 180;
                        } else {
                            // Chase target
                            animal.x += (dx / dist) * animal.speed * 1.2;
                            animal.y += (dy / dist) * animal.speed * 1.2;
                        }
                    }

                    // Update cooldown
                    if (animal.huntCooldown > 0) {
                        animal.huntCooldown--;
                    }
                }
            });

            // Update humans (move toward player if too close)
            gameState.humans.forEach(human => {
                const dx = gameState.x - human.x;
                const dy = gameState.y - human.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < 200 && dist > 30) {
                    human.angle = Math.atan2(dy, dx);
                    human.x += Math.cos(human.angle) * human.speed;
                    human.y += Math.sin(human.angle) * human.speed;
                } else {
                    human.angle += (Math.random() - 0.5) * 0.1;
                    human.x += Math.cos(human.angle) * human.speed * 0.5;
                    human.y += Math.sin(human.angle) * human.speed * 0.5;
                }

                human.x = Math.max(20, Math.min(canvas.width - 20, human.x));
                human.y = Math.max(20, Math.min(canvas.height - 20, human.y));
            });

            // Check for game over (only show once, not repeatedly)
            if (gameState.hunger <= 0 && !gameState.hasShownHungerWarning) {
                addMessage("You're starving! Find food quickly!");
                gameState.hasShownHungerWarning = true;
            } else if (gameState.hunger > 20) {
                gameState.hasShownHungerWarning = false;
            }

            if (gameState.energy <= 0 && !gameState.hasShownEnergyWarning) {
                addMessage("You're exhausted! Rest at your den!");
                gameState.hasShownEnergyWarning = true;
            } else if (gameState.energy > 20) {
                gameState.hasShownEnergyWarning = false;
            }

            updateUI();
        }

        function render() {
            const isNight = gameState.timeOfDay > 50;
            const bgColor = isNight ? '#1a2a1a' : '#4a7c2a';

            // Clear canvas
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw stars at night
            if (isNight) {
                ctx.fillStyle = '#fff';
                for (let i = 0; i < 50; i++) {
                    const x = (i * 37) % canvas.width;
                    const y = (i * 23) % canvas.height;
                    ctx.fillRect(x, y, 2, 2);
                }
            }

            // Draw grass pattern
            ctx.fillStyle = isNight ? '#2a3a2a' : '#5a8c3a';
            for (let i = 0; i < 80; i++) {
                ctx.fillRect(
                    Math.random() * canvas.width,
                    Math.random() * canvas.height,
                    2, 2
                );
            }

            // Draw all dens
            if (gameState.denBuilt && gameState.den) {
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(gameState.den.x - 25, gameState.den.y - 25, 50, 50);
                ctx.fillStyle = '#654321';
                ctx.fillRect(gameState.den.x - 20, gameState.den.y - 20, 40, 40);
                ctx.fillStyle = '#000';
                ctx.fillRect(gameState.den.x - 8, gameState.den.y - 8, 16, 16);
                ctx.font = '20px Arial';
                ctx.fillText('üè†', gameState.den.x - 10, gameState.den.y + 10);
            }

            // Draw ally dens (exclude player's main den)
            gameState.dens.forEach(den => {
                if (den.type === 'ally') {
                    ctx.fillStyle = '#6B4423';
                    ctx.fillRect(den.x - 20, den.y - 20, 40, 40);
                    ctx.fillStyle = '#5A3412';
                    ctx.fillRect(den.x - 15, den.y - 15, 30, 30);
                    ctx.font = '18px Arial';
                    ctx.fillText('üè°', den.x - 9, den.y + 9);
                }
            });

            // Draw food items
            gameState.foodItems.forEach(food => {
                if (!food.collected) {
                    ctx.font = '20px Arial';
                    ctx.fillText('üçé', food.x - 10, food.y + 10);
                }
            });

            // Draw wildlife
            gameState.wildlife.forEach(animal => {
                if (animal.health > 0) {
                    const emoji = animal.type === 'rabbit' ? 'üê∞' : 'ü¶å';
                    ctx.font = '28px Arial';
                    if (animal.tamed) {
                        ctx.fillText('‚ú®', animal.x - 12, animal.y - 15);
                    }
                    ctx.fillText(emoji, animal.x - 14, animal.y + 14);
                }
            });

            // Draw humans
            gameState.humans.forEach(human => {
                if (human.health > 0) {
                    ctx.font = '24px Arial';
                    ctx.fillText('üë§', human.x - 12, human.y + 12);
                }
            });

            // Draw tamed allies
            gameState.allies.forEach((ally, i) => {
                ctx.font = '24px Arial';
                ctx.fillText(ally.emoji, ally.x - 12, ally.y + 12);
            });

            // Draw player
            const emoji = gameState.animal === 'lion' ? 'ü¶Å' :
                gameState.animal === 'wolf' ? 'üê∫' : 'ü¶ä';
            ctx.font = '36px Arial';
            ctx.fillText(emoji, gameState.x - 18, gameState.y + 18);
        }

        // Movement
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        function movePlayer() {
            const stats = animalStats[gameState.animal];
            const speed = stats.speed;
            let moved = false;

            if (keys['ArrowUp'] || keys['w'] || keys['W']) {
                gameState.y = Math.max(18, gameState.y - speed);
                moved = true;
            }
            if (keys['ArrowDown'] || keys['s'] || keys['S']) {
                gameState.y = Math.min(canvas.height - 18, gameState.y + speed);
                moved = true;
            }
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
                gameState.x = Math.max(18, gameState.x - speed);
                moved = true;
            }
            if (keys['ArrowRight'] || keys['d'] || keys['D']) {
                gameState.x = Math.min(canvas.width - 18, gameState.x + speed);
                moved = true;
            }

            if (moved) {
                gameState.energy = Math.max(0, gameState.energy - 0.08);
                checkFoodCollision();
                checkDenInteraction();
                checkWildlifeInteraction();
                checkHumanInteraction();
            }
        }

        function checkFoodCollision() {
            gameState.foodItems.forEach(food => {
                if (!food.collected) {
                    const dist = Math.sqrt(
                        Math.pow(gameState.x - food.x, 2) +
                        Math.pow(gameState.y - food.y, 2)
                    );
                    if (dist < 25) {
                        food.collected = true;
                        gameState.food++;
                        gameState.hunger = Math.min(100, gameState.hunger + 15);
                        addMessage("Yum! You found food! Your hunger is satisfied.");

                        // Respawn food
                        setTimeout(() => {
                            food.x = Math.random() * canvas.width;
                            food.y = Math.random() * canvas.height;
                            food.collected = false;
                        }, 5000);
                    }
                }
            });
        }

        function checkWildlifeInteraction() {
            gameState.wildlife.forEach(animal => {
                if (animal.health > 0) {
                    const dist = Math.sqrt(
                        Math.pow(gameState.x - animal.x, 2) +
                        Math.pow(gameState.y - animal.y, 2)
                    );
                    if (dist < 30) {
                        // Can interact
                    }
                }
            });
        }

        function checkHumanInteraction() {
            gameState.humans.forEach(human => {
                if (human.health > 0) {
                    const dist = Math.sqrt(
                        Math.pow(gameState.x - human.x, 2) +
                        Math.pow(gameState.y - human.y, 2)
                    );
                    if (dist < 40) {
                        // Human is too close - threat! (only show once per human encounter)
                        if (!human.hasWarned) {
                            addMessage("‚ö†Ô∏è Human nearby! Defend your territory!");
                            human.hasWarned = true;
                            gameState.energy = Math.max(0, gameState.energy - 2);
                        }
                    } else if (dist > 100) {
                        human.hasWarned = false; // Reset warning when human moves away
                    }
                }
            });
        }

        function checkDenInteraction() {
            // Check player's main den
            if (gameState.denBuilt && gameState.den) {
                const dist = Math.sqrt(
                    Math.pow(gameState.x - gameState.den.x, 2) +
                    Math.pow(gameState.y - gameState.den.y, 2)
                );
                if (dist < 50) {
                    gameState.energy = Math.min(100, gameState.energy + 0.3);
                }
            }

            // Check ally dens too
            gameState.dens.forEach(den => {
                if (den.type === 'ally') {
                    const dist = Math.sqrt(
                        Math.pow(gameState.x - den.x, 2) +
                        Math.pow(gameState.y - den.y, 2)
                    );
                    if (dist < 50) {
                        gameState.energy = Math.min(100, gameState.energy + 0.2);
                    }
                }
            });
        }

        function applyAnimalTheme() {
            const sidebarPanels = document.querySelectorAll('.info-panel');

            const colors = {
                lion: '#cc8a00',
                wolf: '#6fa3ff',
                fox: '#ff7b47'
            };

            const color = colors[gameState.animal] || '#4a7c2a';

            sidebarPanels.forEach(panel => {
                panel.style.borderColor = color;
            });
        }

        function updateTitleIcon() {
            const title = document.getElementById('titleIcon');
            const icons = {
                lion: "ü¶Å Aria's Wild World",
                wolf: "üê∫ Aria's Wild World",
                fox: "ü¶ä Aria's Wild World"
            };
            title.textContent = icons[gameState.animal] || "üêæ Aria's Wild World";
        }

        // UI Updates
        function updateUI() {
            document.getElementById('animalName').textContent =
                gameState.animal ? gameState.animal.charAt(0).toUpperCase() + gameState.animal.slice(1) : '-';
            document.getElementById('dayCount').textContent = gameState.day;
            document.getElementById('hungerBar').style.width = gameState.hunger + '%';
            document.getElementById('energyBar').style.width = gameState.energy + '%';
            document.getElementById('foodCount').textContent = gameState.food;
            document.getElementById('huntedCount').textContent = gameState.hunted;
            document.getElementById('alliesCount').textContent = gameState.allies.length;
            document.getElementById('denStatus').textContent = gameState.denBuilt ? 'Built' : 'None';
            document.getElementById('densCount').textContent = gameState.dens.length;
            document.getElementById('allyFoodCount').textContent = gameState.allyFood;

            // Update build den button text
            const buildBtn = document.getElementById('buildDenBtn');
            if (gameState.allies.length > 0) {
                const unassigned = gameState.wildlife.filter(a => a.tamed && !a.assignedDen).length;
                if (unassigned > 0) {
                    buildBtn.textContent = `üè° Build Dens (${unassigned} need homes)`;
                } else {
                    buildBtn.textContent = 'üè° Build More Dens';
                }
            } else {
                buildBtn.textContent = 'üè† Move Your Den';
            }
        }

        function addMessage(text) {
            // Prevent duplicate messages
            if (gameState.seenMessages.has(text)) {
                return;
            }

            // Throttle messages - at least 2 seconds between messages
            const now = Date.now();
            if (now - gameState.lastMessageTime < 2000) {
                return;
            }

            gameState.lastMessageTime = now;
            gameState.seenMessages.add(text);

            // Keep only last 20 seen messages to prevent memory bloat
            if (gameState.seenMessages.size > 20) {
                const first = gameState.seenMessages.values().next().value;
                gameState.seenMessages.delete(first);
            }

            const messageBox = document.getElementById('messageBox');
            const message = document.createElement('div');
            message.className = 'message';
            message.textContent = text;

            // insert newest at TOP
            messageBox.insertBefore(message, messageBox.firstChild);

            // keep last 8 visible
            while (messageBox.children.length > 8) {
                messageBox.removeChild(messageBox.lastChild);
            }
        }

        // Buttons
        document.getElementById('buildDenBtn').addEventListener('click', () => {
            // Check if player wants to build ally den or move their own den
            if (gameState.allies.length > 0) {
                // Build den for allies (or let tamed animals build their own)
                if (gameState.energy < 10) {
                    addMessage("You need a bit more energy to build a den!");
                    return;
                }

                // Check if any tamed animals need dens
                const unassignedAllies = gameState.wildlife.filter(a => a.tamed && !a.assignedDen);

                if (unassignedAllies.length > 0) {
                    // Let tamed animals build their own dens automatically
                    unassignedAllies.forEach(ally => {
                        const newDen = {
                            x: ally.x + (Math.random() - 0.5) * 40,
                            y: ally.y + (Math.random() - 0.5) * 40,
                            type: 'ally',
                            owner: ally.type
                        };
                        // Keep in bounds
                        newDen.x = Math.max(30, Math.min(canvas.width - 30, newDen.x));
                        newDen.y = Math.max(30, Math.min(canvas.height - 30, newDen.y));

                        gameState.dens.push(newDen);
                        ally.assignedDen = newDen;
                    });

                    gameState.energy -= 10;
                    addMessage(`Your ${unassignedAllies.length} tamed ${unassignedAllies.length === 1 ? 'ally' : 'allies'} built ${unassignedAllies.length === 1 ? 'a den' : 'dens'}!`);
                    addMessage("They'll now hunt and bring food back to their homes!");
                } else {
                    // Build a new den at player location for future allies
                    const newDen = { x: gameState.x, y: gameState.y, type: 'ally' };
                    gameState.dens.push(newDen);
                    gameState.energy -= 10;
                    addMessage("You built a new den! Tame more animals and they'll move in!");
                }
            } else {
                // Move player's den to new location
                if (gameState.energy < 5) {
                    addMessage("You need a bit of energy to move your den!");
                    return;
                }
                gameState.den = { x: gameState.x, y: gameState.y };
                // Update the den in dens array
                const playerDenIndex = gameState.dens.findIndex(d => d.type === 'player');
                if (playerDenIndex >= 0) {
                    gameState.dens[playerDenIndex] = { x: gameState.x, y: gameState.y, type: 'player' };
                }
                gameState.energy -= 5;
                addMessage("You moved your den to this location!");
            }
        });

        document.getElementById('restBtn').addEventListener('click', () => {
            if (!gameState.denBuilt) {
                addMessage("You need to build a den first to rest safely!");
                return;
            }
            if (gameState.den) {
                const dist = Math.sqrt(
                    Math.pow(gameState.x - gameState.den.x, 2) +
                    Math.pow(gameState.y - gameState.den.y, 2)
                );
                if (dist < 60) {
                    gameState.energy = 100;
                    gameState.hunger = Math.max(0, gameState.hunger - 3);
                    gameState.day++;
                    addMessage(`You rested well! Day ${gameState.day} begins.`);
                    addMessage("The world feels different today...");
                } else {
                    addMessage("Go to your den to rest safely!");
                }
            }
        });

        document.getElementById('huntBtn').addEventListener('click', () => {
            const stats = animalStats[gameState.animal];
            let foundPrey = false;

            gameState.wildlife.forEach(animal => {
                if (animal.health > 0 && !animal.tamed) {
                    const dist = Math.sqrt(
                        Math.pow(gameState.x - animal.x, 2) +
                        Math.pow(gameState.y - animal.y, 2)
                    );
                    if (dist < 40) {
                        foundPrey = true;
                        const success = Math.random() < (stats.hunting / 10);
                        if (success) {
                            animal.health = 0;
                            gameState.hunted++;
                            gameState.hunger = Math.min(100, gameState.hunger + 30);
                            gameState.energy = Math.max(0, gameState.energy - 10);
                            addMessage(`Successful hunt! You caught a ${animal.type}!`);
                            addMessage("Hunting gives you more food than plants.");

                            // Respawn new animal
                            setTimeout(() => {
                                animal.x = Math.random() * canvas.width;
                                animal.y = Math.random() * canvas.height;
                                animal.health = 100;
                                animal.tamed = false;
                            }, 8000);
                        } else {
                            gameState.energy = Math.max(0, gameState.energy - 5);
                            addMessage("The prey got away! Try again when you're closer.");
                        }
                    }
                }
            });

            if (!foundPrey) {
                addMessage("No prey nearby! Look for rabbits üê∞ or deer ü¶å.");
            }
        });

        document.getElementById('tameBtn').addEventListener('click', () => {
            let foundAnimal = false;

            gameState.wildlife.forEach(animal => {
                if (animal.health > 0 && !animal.tamed) {
                    const dist = Math.sqrt(
                        Math.pow(gameState.x - animal.x, 2) +
                        Math.pow(gameState.y - animal.y, 2)
                    );
                    if (dist < 35) {
                        foundAnimal = true;
                        const success = Math.random() < 0.4;
                        if (success) {
                            animal.tamed = true;
                            animal.assignedDen = null; // Will be assigned to nearest den
                            animal.hunting = false;
                            animal.huntCooldown = 0;
                            gameState.allies.push({
                                x: animal.x,
                                y: animal.y,
                                emoji: animal.type === 'rabbit' ? 'üê∞' : 'ü¶å',
                                type: animal.type
                            });
                            addMessage(`üéâ You tamed a ${animal.type}! They're now your ally!`);
                            addMessage("Your new ally will automatically build a den and start hunting!");
                            addMessage("Click 'Build Den' to help them set up their home, or they'll do it themselves!");
                        } else {
                            gameState.energy = Math.max(0, gameState.energy - 3);
                            addMessage("The animal is still scared. Try again!");
                        }
                    }
                }
            });

            if (!foundAnimal) {
                addMessage("No animals nearby to tame! Get closer to wildlife.");
            }
        });

        document.getElementById('defendBtn').addEventListener('click', () => {
            if (!gameState.denBuilt) {
                addMessage("Build a den first to have territory to defend!");
                return;
            }

            let foundHuman = false;
            gameState.humans.forEach(human => {
                if (human.health > 0) {
                    const distToHuman = Math.sqrt(
                        Math.pow(gameState.den.x - human.x, 2) +
                        Math.pow(gameState.den.y - human.y, 2)
                    );
                    const distToPlayer = Math.sqrt(
                        Math.pow(gameState.x - human.x, 2) +
                        Math.pow(gameState.y - human.y, 2)
                    );

                    if (distToHuman < 100 || distToPlayer < 50) {
                        foundHuman = true;
                        const stats = animalStats[gameState.animal];
                        const success = Math.random() < (stats.strength / 10);

                        if (success) {
                            human.health -= 20;
                            gameState.energy = Math.max(0, gameState.energy - 8);
                            if (human.health <= 0) {
                                addMessage("You defended your territory! The human left.");
                                setTimeout(() => {
                                    human.x = Math.random() * canvas.width;
                                    human.y = Math.random() * canvas.height;
                                    human.health = 50;
                                }, 10000);
                            } else {
                                addMessage("You scared the human away! They're retreating.");
                            }
                        } else {
                            gameState.energy = Math.max(0, gameState.energy - 5);
                            gameState.hunger = Math.max(0, gameState.hunger - 5);
                            addMessage("The human is strong! You need more energy to fight.");
                        }
                    }
                }
            });

            if (!foundHuman) {
                addMessage("No humans near your territory right now.");
            }
        });

        document.getElementById('saveBtn').addEventListener('click', () => {
            saveGame();
            addMessage("Game saved! Your progress is safe.");
        });

        // Save/Load
        function saveGame() {
            const saveData = {
                animal: gameState.animal,
                x: gameState.x,
                y: gameState.y,
                hunger: gameState.hunger,
                energy: gameState.energy,
                food: gameState.food,
                hunted: gameState.hunted,
                allyFood: gameState.allyFood,
                day: gameState.day,
                den: gameState.den,
                denBuilt: gameState.denBuilt,
                dens: gameState.dens || [],
                allies: gameState.allies
            };
            localStorage.setItem('ariasWildWorld', JSON.stringify(saveData));
        }

        function loadGame() {
            const saved = localStorage.getItem('ariasWildWorld');
            if (saved) {
                const savedState = JSON.parse(saved);
                Object.assign(gameState, savedState);
                // Ensure dens array exists
                if (!gameState.dens) {
                    gameState.dens = [];
                    if (gameState.den) {
                        gameState.dens.push({ x: gameState.den.x, y: gameState.den.y, type: 'player' });
                    }
                }
                // Ensure allyFood exists
                if (gameState.allyFood === undefined) {
                    gameState.allyFood = 0;
                }
                // Ensure fullMapMode exists
                if (gameState.fullMapMode === undefined) {
                    gameState.fullMapMode = true;
                }
                addMessage("Welcome back! Your progress has been loaded.");
            } else {
                // New game - ensure starting den
                gameState.den = { x: gameState.x, y: gameState.y };
                gameState.denBuilt = true;
                gameState.dens = [{ x: gameState.x, y: gameState.y, type: 'player' }];
            }
        }

        // Continuous movement check
        setInterval(() => {
            movePlayer();
        }, 16);
    </script>
</body>

</html>